*ğŸ“ Design Spec: Enhanced Multi-API Chat App (mychat-enhanced.py) v2*

*1. Intro*
This doc details the design & functionality of an enhanced multi-API chat app. It's built with Python & Tkinter. This version has *message formatting*, *async API calls*, *file attachments*, *Ollama model selection*, & a *slicker UI*. âœ¨

*2. Goals*
*   âœ… User-friendly, robust multi-AI chat interface.
*   âœ… Switch seamlessly between AI providers: Google Gemini, OpenAI, Ollama, xAI Grok, Anthropic Claude.
*   âœ… Format text: *bold*, _italic_, ~underline~.
*   âœ… Keep UI responsive with async API requests.
*   âœ… Attach files to chat sessions.
*   âœ… Save chat sessions, configs, & file attachments.
*   âœ… Pick specific Ollama models.
*   âœ… Solid error handling & user feedback. âš ï¸

*3. Architecture*
*   *Modular & Object-Oriented:*
    *   `APIConfig` class: Handles API provider settings, incl. Ollama model dropdown.
    *   `ChatApplication` class: Manages app logic, UI, & API interaction.
*   *Config:* `config.yaml` for API keys, settings etc. âš™ï¸
*   *UI:* Tkinter for GUI. ğŸ–¼ï¸
*   *API Libs:* `google.generativeai`, `openai`, `anthropic`, `requests`. ğŸ“š
*   *Async:* Threading + Message Queue (queue.Queue) for non-blocking API requests. â³
*   *Data:* Chat sessions as JSON files in `chat_logs/`, attachments within session files. ğŸ—„ï¸
*   *Files:* File attachments managed & stored in memory (currently). ğŸ“

*4. Functionality*
*   *API Config (`APIConfig` class):*
    *   âš™ï¸ Configure API keys, base URLs, models, system prompts, temp.
    *   â¬‡ï¸ Ollama model selection via dropdown (`ollama list`).
    *   ğŸ›ï¸ Dynamically show/hide Ollama fields based on active API.
    *   ğŸ’¾ Saves active provider settings.
    *   âš ï¸ Error handling when listing Ollama models.
*   *Main Chat Window (`ChatApplication` class):*
    *   *Sessions (Left Panel):*
        *   ğŸ“œ Saved sessions in Listbox.
        *   â• New session button (timestamped).
        *   ğŸ—‘ï¸ Delete session button.
        *   ğŸ‘† Double-click loads session.
    *   *Chat Display (Right Panel):*
        *   ğŸ’¬ `ScrolledText` for messages.
        *   ğŸ·ï¸ Current API provider label.
        *   ğŸ–±ï¸ Right-click context menu for copying.
        *   âœ¨ Text formatting with special sequences: *bold*, _italic_, ~underline~.
    *   *Message Input:*
        *   âŒ¨ï¸ Multi-line `Text` widget for input.
        *   â†©ï¸ Enter sends message.
        *   âŒ¨ï¸ Formatting shortcuts:
            *   Ctrl+b: *bold*
            *   Ctrl+i: _italic_
            *   Ctrl+u: ~underline~
        *   ğŸ˜Š Basic emoji insertion.
    *   *Chat Interaction:*
        *   ğŸ“¤ User message added to history & display.
        *   ğŸ¤– AI response in separate thread.
        *   ğŸ“ Messages saved with timestamps & senders.
        *   ğŸ“š Conversation history in structured format: `{"role": "user/model", "parts":[message]}`.
    *   *Async API:*
        *   ğŸ§µ Uses `threading.Thread` + `queue.Queue` for background API calls.
        *   âœ… Prevents UI freezes.
        *  ğŸ” Implemented Error retries.
        *   ğŸ–Œï¸ Updates UI with `self.root.after` (thread-safe).
    *   *File Attachments:*
        *    ğŸ“ Attach button opens file dialog.
        *    ğŸ’¾ File data & metadata stored in `self.attached_files`.
        *    ğŸ‘ï¸â€ğŸ—¨ï¸ Info displayed in chat & saved in session log.
        *   âš ï¸ *Currently, files are stored in memory.*
    *   *Ollama:*
        *  âœ… Ollama models are listed using `ollama list`.
        *  ğŸš€ Selected model is used when generating response.
    *  *Message Formatting:*
         *  âœ… Messages can be formatted using `*bold*`, `_italic_`, `~underline~`
         *  ğŸ¨ Formatted message is shown in chat output.
    *  *Exporting:*
        *  â¡ï¸ Exports to `.txt` including messages, timestamps & attached file info.
    *   *Data:*
        *   ğŸ’¾ Chat sessions saved as JSON (`chat_logs/`).
        *   âš™ï¸ Configs in `config.yaml`.
        *   ğŸ“‚ Attachments in `self.attached_files`.
    *   *Error Handling:*
        *  âš ï¸ `messagebox` for important steps.
        *  ğŸ” Retries for API connection issues & rate limits (basic).

*5. API Usage*
*   *Google Gemini:* `google.generativeai` for text gen.
*   *OpenAI:* `openai` for chat completions.
*   *Ollama:* `subprocess` to run `ollama run`.
*   *xAI Grok:* `requests` for RESTful API.
*  *Anthropic Claude:* `anthropic` for chat completion.

*6. Data Structures*
*   `self.config`: dict for all configs (from `config.yaml`).
*   `self.sessions`: dict of chat sessions: `{session_name: [(sender, message, timestamp), ...]}`
*   `self.conversation_history`: list of messages for API calls: `[{"role": "user/model", "parts":[message]}, ...]`
*   `self.log_dir`: string for the log directory path.
*   `self.attached_files`: dict of file attachments: `{session_name: {file_index : {"file_path": <file_path>, "file_name":<file_name>, "file_content":<bytes>}}}`

*7. UI Details*
*   *Left Panel:* Sessions (listbox, buttons).
*   *Right Panel:* Chat (`ScrolledText`, `Text` input, buttons).
*   *Colors:* Consistent theme for clarity.
*   *Fonts:* Styles for *bold*, _italic_, ~underline~.

*8. Improvements*
*   âœ… Advanced message formatting.
*   âœ… Ollama model selection.
*   âœ… Improved error handling.
*   âœ… Asynchronous API requests.
*   âœ… File attachments.
*   âœ… Refined UI.

*9. Technical Details*
*   Text formatting via `*`, `_`, `~`.
*   `threading` for smoother UI during API calls.
*   `try/except` for error catching.
*   File attachment data stored in memory (not on disk, *future enhancement needed*).
*   `ollama list` for available Ollama models.

*10. Debugging Tips & Future Enhancements*
*   *Debugging:*
    *   Use print statements to track message flow and API calls (consider adding proper logging in future).
    *   Check console for error messages and tracebacks.
    *   Verify `config.yaml` is correctly updated.
    *   Use try/except blocks to catch and handle errors gracefully, consider raising custom exceptions for easier identification of issues.
*   *Future:*
    *   ğŸ’¾ Save/load attached files to disk.
    *   ğŸ–¼ï¸ Image attachments with inline viewing.
    *   ğŸ¨ More robust message formatting & code block highlighting.
    *   ğŸ” Message search functionality.
    *   ğŸ“ Markdown support.
    *   âŒ¨ï¸ Code syntax highlighting.
    *   ğŸ“ˆ Improve UI/UX even further.
    *   ğŸ’¾ Session backup/restore.
    *   ğŸ” Implement API rate limit handling.
    *   â° Proper logging system (e.g., `logging` module).
    *   â™»ï¸ Consider a more sophisticated message queue if the project scales.
    *   ğŸ“¦ Modularize classes into separate files for readability
*   *Known Issues:*
    *   Memory usage could increase with many/large file attachments.
    *   Error handling is basic for rate limiting.

